<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Canvas AI Chat Assistant</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
	<script>
		tailwind.config = {
			theme: {
				extend: {},
				fontFamily: {
					sans: ['Inter','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Noto Sans','Helvetica Neue','Arial','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol']
				}
			}
		}
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
	<style>
		body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol' !important; background-color: #f9fafb !important; color: #000 !important; }
		h1, h2, h3, h4, h5, h6 { color: #000 !important; }

		/* Markdown æ ·å¼ï¼ˆ4/8pt é—´è·ç³»ç»Ÿï¼›ä»…é»‘/ç™½æ–‡æœ¬ï¼‰ */
		.bubble .markdown-body { line-height: 1.5; }
		.bubble .markdown-body p { margin: 8px 0; }
		.bubble .markdown-body ul, .bubble .markdown-body ol { margin: 8px 0; padding-left: 20px; }
		.bubble .markdown-body li { margin: 4px 0; }
		.bubble .markdown-body h1 { font-size: 24px; font-weight: 700; margin: 8px 0; }
		.bubble .markdown-body h2 { font-size: 20px; font-weight: 600; margin: 8px 0; }
		.bubble .markdown-body h3 { font-size: 18px; font-weight: 600; margin: 8px 0; }
		.bubble .markdown-body blockquote { border-left: 4px solid currentColor; padding-left: 12px; margin: 8px 0; opacity: 0.9; }
		.bubble .markdown-body a { text-decoration: underline; }
		/* ä»£ç æ ·å¼ï¼ˆæµ…/æ·±æ°”æ³¡åŒºåˆ†ï¼‰ */
		.bubble .markdown-body code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 0.875rem; padding: 4px 4px; border-radius: 3px; border: 1px solid transparent; }
		.bubble .markdown-body pre { margin: 8px 0; padding: 8px 16px; border-radius: 3px; overflow-x: auto; border: 1px solid transparent; }
		/* AIï¼ˆæµ…è‰²æ°”æ³¡ï¼‰ */
		.bubble-ai .markdown-body { color: #000; }
		.bubble-ai .markdown-body code { background: #f3f4f6; color: #000; border-color: #e5e7eb; }
		.bubble-ai .markdown-body pre { background: #f3f4f6; color: #000; border-color: #e5e7eb; }
		/* ç”¨æˆ·ï¼ˆæ·±è‰²æ°”æ³¡ï¼‰ */
		.bubble-user .markdown-body { color: #fff; }
		.bubble-user .markdown-body a { color: #fff; }
		.bubble-user .markdown-body code { background: rgba(255,255,255,0.12); color: #fff; border-color: rgba(255,255,255,0.2); }
		.bubble-user .markdown-body pre { background: #0f0f0f; color: #fff; border-color: #222; }
	</style>
</head>
<body class="antialiased">
	<!-- é¡¶éƒ¨å¯¼èˆª -->
	<nav class="sticky top-0 z-10 bg-white border-b border-gray-200/80">
		<div class="max-w-6xl mx-auto px-4">
			<div class="h-14 flex items-center justify-between">
				<div class="flex items-center gap-2">
					<i data-lucide="message-square" class="w-5 h-5"></i>
					<span class="text-xl font-semibold tracking-tight">Canvas åŠ©æ‰‹</span>
				</div>
				<div class="hidden sm:flex items-center gap-3">
					<button id="checkHealth" class="px-3 py-2 rounded-[3px] bg-black text-white text-sm transition-colors hover:bg-neutral-900">æ£€æŸ¥åç«¯ /api/health</button>
				</div>
			</div>
		</div>
	</nav>

	<!-- ä¸»ä½“å¸ƒå±€ -->
	<main class="max-w-6xl mx-auto px-4 py-6">
		<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- ä¾§æ ï¼šè¿æ¥è®¾ç½® / å·¥å…·æµ‹è¯• / æ–‡ä»¶æµè§ˆ -->
            <aside class="lg:col-span-4 space-y-6">
				<section class="bg-white rounded-[3px] shadow-sm border border-gray-200">
					<div class="p-4 space-y-3">
						<h2 class="text-lg font-semibold">è¿æ¥è®¾ç½®</h2>
						<label class="block">
							<span class="text-sm font-medium">Canvas API Token</span>
							<input id="token" type="password" placeholder="ç²˜è´´ä½ çš„ Canvas Token" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
						</label>
						<label class="block">
							<span class="text-sm font-medium">LLM Base URL</span>
							<input id="llmBaseURL" type="text" placeholder="å¦‚ https://api.openai-compatible.example/v1" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
						</label>
						<label class="block">
							<span class="text-sm font-medium">LLM API Keyï¼ˆä»…ç”¨äºåç«¯è°ƒç”¨ï¼‰</span>
							<input id="llmApiKey" type="password" placeholder="åç«¯ä¼šä»è¯·æ±‚å¤´ X-LLM-KEY è¯»å–ï¼ˆä»…æœ¬åœ°æ¼”ç¤ºå¯é€‰ï¼‰" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
						</label>
						<p class="text-xs text-gray-600">å®‰å…¨æ€§ï¼šToken ä»…å­˜å‚¨äº sessionStorageï¼Œå…³é—­æ ‡ç­¾é¡µå³æ¸…é™¤ã€‚</p>
					</div>
				</section>

                <section class="bg-white rounded-[3px] shadow-sm border border-gray-200">
					<div class="p-4 space-y-3">
						<h3 class="text-base font-medium">å·¥å…·æµ‹è¯•</h3>
						<label class="block">
							<span class="text-sm font-medium">é€‰æ‹©å·¥å…·</span>
							<select id="toolSelect" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800">
								<option value="list_my_courses">list_my_coursesï¼ˆåˆ—å‡ºè¯¾ç¨‹ï¼‰</option>
								<option value="get_upcoming_assignments">get_upcoming_assignmentsï¼ˆæœªæˆªæ­¢ä½œä¸šï¼‰</option>
								<option value="get_announcements">get_announcementsï¼ˆè¯¾ç¨‹å…¬å‘Šï¼‰</option>
							</select>
						</label>
						<label class="block">
							<span class="text-sm font-medium">è¯¾ç¨‹åç§°ï¼ˆå¯é€‰ï¼Œä»…å…¬å‘Šï¼‰</span>
							<input id="toolCourse" type="text" placeholder="ä¾‹å¦‚ï¼šCalculus / ç•™ç©º=å…¨éƒ¨è¯¾ç¨‹" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
						</label>
						<div class="pt-1">
							<button id="runToolBtn" class="w-full px-3 py-2 rounded-[3px] bg-black text-white text-sm transition-colors hover:bg-neutral-900">è¿è¡Œå·¥å…·æµ‹è¯•ï¼ˆç›´è¿å·¥å…·ï¼‰</button>
						</div>
					</div>
				</section>

                <section id="fileBrowserSection" class="bg-white rounded-[3px] shadow-sm border border-gray-200 hidden">
                    <div class="p-4 space-y-3">
                        <h3 class="text-base font-medium">è¯¾ç¨‹æ–‡ä»¶æµè§ˆ</h3>
                        <label class="block">
                            <span class="text-sm font-medium">è¯¾ç¨‹ ID</span>
                            <input id="courseIdInput" type="number" inputmode="numeric" placeholder="å¡«å†™è¯¾ç¨‹ IDï¼ˆå¯å…ˆç”¨è¯¾ç¨‹åˆ—è¡¨å·¥å…·è·å–ï¼‰" class="mt-2 w-full h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
                        </label>
                        <div class="pt-1">
                            <button id="loadTreeBtn" class="w-full px-3 py-2 rounded-[3px] bg-black text-white text-sm transition-colors hover:bg-neutral-900">åŠ è½½æ–‡ä»¶æ ‘</button>
                        </div>
                        <div id="fileTree" class="mt-2 text-sm"></div>
                    </div>
                </section>
			</aside>

			<!-- ä¸»å†…å®¹ï¼šèŠå¤© -->
			<section class="lg:col-span-8 bg-white rounded-[3px] shadow-sm border border-gray-200">
				<div class="p-4 border-b border-gray-200">
					<h2 class="text-lg font-semibold">å¯¹è¯</h2>
				</div>
				<div class="p-4">
					<div id="chat" class="h-[60vh] overflow-y-auto p-3 space-y-2 bg-white"></div>
					<template id="file-card-template">
						<div class="border border-gray-200 rounded-[3px] p-3 bg-gray-50">
							<div class="flex items-center justify-between mb-2">
								<div class="text-sm font-medium">è¯¾ç¨‹æ–‡ä»¶æµè§ˆ</div>
								<button data-role="close" class="text-xs underline">å…³é—­</button>
							</div>
                    <div class="flex items-center gap-2 mb-2">
                        <select data-role="courseSelect" class="flex-1 h-9 px-2 py-1 border border-gray-300 rounded-[3px] bg-white text-black focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800">
                            <option value="" disabled selected>é€‰æ‹©ä¸€é—¨å·²é€‰è¯¾ç¨‹</option>
                        </select>
                        <button data-role="load" class="h-9 px-3 rounded-[3px] bg-black text-white text-xs">åŠ è½½</button>
                    </div>
							<div data-role="tree" class="text-sm max-h-[45vh] overflow-y-auto"></div>
						</div>
					</template>
					<form id="form" class="mt-2 flex items-center gap-2">
						<input id="question" type="text" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæœ€è¿‘æœ‰ä»€ä¹ˆä½œä¸šè¦äº¤ï¼Ÿ" required class="flex-1 h-11 px-3 py-2 border border-gray-300 rounded-[3px] bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800" />
						<button type="submit" class="px-3 py-2 rounded-[3px] bg-black text-white text-sm transition-colors hover:bg-neutral-900">å‘é€</button>
					</form>
					<div id="status" role="status" class="mt-2 text-sm text-gray-600"></div>
				</div>
			</section>
		</div>
	</main>

	<script>
        const chat = document.getElementById('chat');
		const form = document.getElementById('form');
		const tokenInput = document.getElementById('token');
		const qInput = document.getElementById('question');
		const statusEl = document.getElementById('status');
		const baseUrlInput = document.getElementById('llmBaseURL');
		const llmKeyInput = document.getElementById('llmApiKey');
		const checkBtn = document.getElementById('checkHealth');
		const toolSelect = document.getElementById('toolSelect');
		const toolCourseInput = document.getElementById('toolCourse');
		const runToolBtn = document.getElementById('runToolBtn');
        const courseIdInput = document.getElementById('courseIdInput');
        const loadTreeBtn = document.getElementById('loadTreeBtn');
        const fileTreeEl = document.getElementById('fileTree');
        const fileBrowserSection = document.getElementById('fileBrowserSection');
        const HISTORY_MAX_TURNS = 10; // æœ€å¤šä¿ç•™æœ€è¿‘ N è½®ï¼ˆuser/assistant ä¸€é—®ä¸€ç­”è®¡ 2 æ¡ï¼‰
        let chatHistory = [];
        const DEBUG_MODE = true;

        // æ¢å¤ sessionStorage
		tokenInput.value = sessionStorage.getItem('canvas_token') || '';
		baseUrlInput.value = sessionStorage.getItem('llm_base_url') || '';
		llmKeyInput.value = sessionStorage.getItem('llm_api_key') || '';
        try {
            const raw = sessionStorage.getItem('chat_history');
            chatHistory = Array.isArray(JSON.parse(raw || '[]')) ? JSON.parse(raw || '[]') : [];
        } catch (_) { chatHistory = []; }

		function saveSession() {
			sessionStorage.setItem('canvas_token', tokenInput.value.trim());
			sessionStorage.setItem('llm_base_url', baseUrlInput.value.trim());
			sessionStorage.setItem('llm_api_key', llmKeyInput.value.trim());
		}

        function saveHistory() {
            try {
                sessionStorage.setItem('chat_history', JSON.stringify(chatHistory));
            } catch (_) {}
        }

        function pushHistory(role, content) {
            const r = String(role || '').trim();
            const c = String(content || '');
            chatHistory.push({ role: r === 'user' ? 'user' : 'assistant', content: c });
            // åªä¿ç•™æœ€è¿‘ N è½®ï¼ˆçº¦ 2N æ¡ï¼‰
            const maxItems = HISTORY_MAX_TURNS * 2;
            if (chatHistory.length > maxItems) {
                chatHistory = chatHistory.slice(chatHistory.length - maxItems);
            }
            saveHistory();
        }

        function debugLog(...args) {
            try {
                if (!DEBUG_MODE || !window || !window.console) return;
                const fn = console.log ? console.log.bind(console) : (console.debug ? console.debug.bind(console) : null);
                if (fn) fn('[UI]', ...args);
            } catch (_) {}
        }

		function appendMsg(role, text) {
			const row = document.createElement('div');
			row.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
			const bubble = document.createElement('div');
			const baseBubble = 'bubble inline-block px-3 py-2 rounded-[3px] max-w-[75%] text-sm leading-6';
			const bubbleRole = role === 'user' ? 'bubble-user bg-black text-white' : 'bubble-ai bg-gray-100 text-black';
			bubble.className = baseBubble + ' ' + bubbleRole;
			// Markdown æ¸²æŸ“ + XSS å¤„ç†
			let html = text;
			try {
				if (window.marked && window.DOMPurify) {
					const raw = window.marked.parse(String(text || ''));
					html = window.DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
				} else {
					html = String(text || '');
				}

        function renderTree(node) {
            const container = document.createElement('div');
            container.className = 'space-y-2';

            function createFolder(f) {
                const wrapper = document.createElement('div');
                const header = document.createElement('div');
                header.className = 'flex items-center gap-2 cursor-pointer select-none px-2 py-1 rounded-[3px] hover:bg-gray-100';
                const icon = document.createElement('span');
                icon.textContent = 'ğŸ“';
                const name = document.createElement('span');
                name.textContent = f.name || '(æœªå‘½åæ–‡ä»¶å¤¹)';
                const count = document.createElement('span');
                count.className = 'ml-auto text-xs text-gray-500';
                const totalFiles = (f.files?.length || 0);
                const totalFolders = (f.folders?.length || 0);
                count.textContent = `${totalFolders} æ–‡ä»¶å¤¹ Â· ${totalFiles} æ–‡ä»¶`;
                header.appendChild(icon); header.appendChild(name); header.appendChild(count);

                const children = document.createElement('div');
                children.className = 'ml-4 mt-1 hidden space-y-1';

                if (Array.isArray(f.folders)) {
                    f.folders.forEach(sub => children.appendChild(createFolder(sub)));
                }
                if (Array.isArray(f.files)) {
                    f.files.forEach(file => children.appendChild(createFile(file)));
                }

                header.addEventListener('click', () => {
                    children.classList.toggle('hidden');
                });

                wrapper.appendChild(header);
                wrapper.appendChild(children);
                return wrapper;
            }

            function createFile(file) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 px-2 py-1 rounded-[3px] hover:bg-gray-50';
                const icon = document.createElement('span');
                icon.textContent = 'ğŸ“„';
                const name = document.createElement('span');
                name.textContent = file.display_name || `æ–‡ä»¶ ${file.id}`;
                name.className = 'truncate max-w-[60%]';
                const meta = document.createElement('span');
                meta.className = 'ml-auto text-xs text-gray-500';
                meta.textContent = (file.content_type || '') + (file.size ? ` Â· ${file.size}B` : '');
                const dl = document.createElement('a');
                dl.textContent = 'ä¸‹è½½';
                dl.className = 'text-sm underline ml-3';
                dl.href = `/api/files/${encodeURIComponent(file.id)}/download`;
                dl.target = '_blank';
                dl.addEventListener('click', (e) => {
                    // é€šè¿‡ fetch é™„å¸¦ Tokenï¼ŒæœåŠ¡ç«¯å°†ä½¿ç”¨ X-Canvas-Token ä»£ç†ä¸‹è½½
                    e.preventDefault();
                    const token = tokenInput.value.trim();
                    if (!token) { appendMsg('ai', 'è¯·å…ˆå¡«å†™ Canvas Token'); return; }
                    fetch(dl.href, { headers: { 'X-Canvas-Token': token } })
                        .then(async (resp) => {
                            if (!resp.ok) {
                                const msg = await resp.text().catch(() => resp.statusText);
                                throw new Error(msg || 'ä¸‹è½½å¤±è´¥');
                            }
                            const blob = await resp.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = (file.display_name || `file_${file.id}`);
                            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        })
                        .catch(err => appendMsg('ai', 'ä¸‹è½½å¤±è´¥ï¼š' + (err.message || String(err))));
                });
                row.appendChild(icon); row.appendChild(name); row.appendChild(meta); row.appendChild(dl);
                return row;
            }

            const rootTitle = document.createElement('div');
            rootTitle.className = 'text-sm text-gray-600';
            rootTitle.textContent = (node.full_name || node.name || 'è¯¾ç¨‹æ–‡ä»¶');
            container.appendChild(rootTitle);

            if (Array.isArray(node.folders)) {
                node.folders.forEach(sub => container.appendChild(createFolder(sub)));
            }
            if (Array.isArray(node.files) && node.files.length) {
                const filesWrap = document.createElement('div');
                filesWrap.className = 'mt-1';
                node.files.forEach(f => filesWrap.appendChild(createFile(f)));
                container.appendChild(filesWrap);
            }
            return container;
        }

        // åœ¨å¯¹è¯ä¸­æ’å…¥æ–‡ä»¶æµè§ˆå¡ç‰‡ï¼ˆæŒ‚åˆ° windowï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜ï¼‰
        window.insertFileBrowserCard = function(courseId) {
            debugLog('insertFileBrowserCard()', { courseId });
            const tpl = document.getElementById('file-card-template');
            if (!tpl) return;
            const node = tpl.content.firstElementChild.cloneNode(true);
            const treeEl = node.querySelector('[data-role="tree"]');
            const courseSelect = node.querySelector('[data-role="courseSelect"]');
            const loadBtn = node.querySelector('[data-role="load"]');
            const closeBtn = node.querySelector('[data-role="close"]');

            function loadTreeById(cid) {
                (async () => {
                    try {
                        const token = tokenInput.value.trim();
                        if (!token) { appendMsg('ai', 'è¯·å…ˆå¡«å†™ Canvas Token'); return; }
                        if (!cid) { appendMsg('ai', 'è¯·å¡«å†™æœ‰æ•ˆçš„è¯¾ç¨‹ ID'); return; }
                        statusEl.textContent = 'åŠ è½½æ–‡ä»¶æ ‘ä¸­â€¦';
                        treeEl.innerHTML = '';
                        const url = `/api/courses/${encodeURIComponent(cid)}/file_tree`;
                        debugLog('fetch file_tree', { url, cid });
                        const resp = await fetch(url, { headers: { 'X-Canvas-Token': token } });
                        debugLog('file_tree status', resp.status);
                        if (!resp.ok) {
                            const errText = await resp.text().catch(() => resp.statusText);
                            throw new Error(errText || 'è¯·æ±‚å¤±è´¥');
                        }
                        const data = await resp.json();
                        debugLog('file_tree payload keys', Object.keys(data || {}));
                        const root = (data && data.root) ? data.root : null;
                        if (!root) { treeEl.textContent = 'æœªè·å–åˆ°æ–‡ä»¶æ ‘'; return; }
                        treeEl.appendChild(renderTree(root));
                    } catch (e) {
                        appendMsg('ai', 'åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥ï¼š' + (e.message || String(e)));
                        debugLog('loadTreeById error', e);
                    } finally {
                        statusEl.textContent = '';
                    }
                })();
            }

            // å…ˆè½½å…¥ç”¨æˆ·å·²é€‰è¯¾ç¨‹å¡«å……ä¸‹æ‹‰
            (async () => {
                try {
                    const token = tokenInput.value.trim();
                    if (!token) return;
                    const resp = await fetch('/api/courses', { headers: { 'X-Canvas-Token': token } });
                    if (resp.ok) {
                        const data = await resp.json();
                        const list = Array.isArray(data.courses) ? data.courses : [];
                        list.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = String(c.id);
                            opt.textContent = c.course_code ? `${c.course_code} ${c.name}` : c.name;
                            courseSelect.appendChild(opt);
                        });
                        // å¦‚æœå·¥å…·æŒ‡å®šäº† courseIdï¼Œé¢„é€‰å¹¶åŠ è½½
                        if (courseId) {
                            courseSelect.value = String(courseId);
                            loadTreeById(Number(courseId));
                        }
                    }
                } catch (_) {}
            })();

            loadBtn.addEventListener('click', () => {
                const cid = Number(courseSelect.value || '');
                loadTreeById(cid);
            });
            closeBtn.addEventListener('click', () => { node.remove(); });

            // ä½œä¸º AI æ¶ˆæ¯æ’å…¥
            const row = document.createElement('div');
            row.className = 'flex justify-start';
            const bubble = document.createElement('div');
            bubble.className = 'bubble bubble-ai inline-block px-3 py-2 rounded-[3px] max-w-[75%] text-sm leading-6 bg-gray-100 text-black';
            bubble.appendChild(node);
            row.appendChild(bubble);
            chat.appendChild(row);
            chat.scrollTop = chat.scrollHeight;
        }
			} catch (_) {
				html = String(text || '');
			}
			const wrapper = document.createElement('div');
			wrapper.className = 'markdown-body';
			wrapper.innerHTML = html;
			bubble.appendChild(wrapper);
			row.appendChild(bubble);
			chat.appendChild(row);
			chat.scrollTop = chat.scrollHeight;
		}

        // ç‹¬ç«‹å®šä¹‰æ–‡ä»¶æ ‘æ¸²æŸ“å‡½æ•°ï¼Œä¾›â€œåŠ è½½æ–‡ä»¶æ ‘â€æŒ‰é’®ä½¿ç”¨
        function renderTree(node) {
            const container = document.createElement('div');
            container.className = 'space-y-2';

            function createFolder(f) {
                const wrapper = document.createElement('div');
                const header = document.createElement('div');
                header.className = 'flex items-center gap-2 cursor-pointer select-none px-2 py-1 rounded-[3px] hover:bg-gray-100';
                const icon = document.createElement('span');
                icon.textContent = 'ğŸ“';
                const name = document.createElement('span');
                name.textContent = f.name || '(æœªå‘½åæ–‡ä»¶å¤¹)';
                const count = document.createElement('span');
                count.className = 'ml-auto text-xs text-gray-500';
                const totalFiles = (f.files?.length || 0);
                const totalFolders = (f.folders?.length || 0);
                count.textContent = `${totalFolders} æ–‡ä»¶å¤¹ Â· ${totalFiles} æ–‡ä»¶`;
                header.appendChild(icon); header.appendChild(name); header.appendChild(count);

                const children = document.createElement('div');
                children.className = 'ml-4 mt-1 hidden space-y-1';

                if (Array.isArray(f.folders)) {
                    f.folders.forEach(sub => children.appendChild(createFolder(sub)));
                }
                if (Array.isArray(f.files)) {
                    f.files.forEach(file => children.appendChild(createFile(file)));
                }

                header.addEventListener('click', () => {
                    children.classList.toggle('hidden');
                });

                wrapper.appendChild(header);
                wrapper.appendChild(children);
                return wrapper;
            }

            function createFile(file) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 px-2 py-1 rounded-[3px] hover:bg-gray-50';
                const icon = document.createElement('span');
                icon.textContent = 'ğŸ“„';
                const name = document.createElement('span');
                name.textContent = file.display_name || `æ–‡ä»¶ ${file.id}`;
                name.className = 'truncate max-w-[60%]';
                const meta = document.createElement('span');
                meta.className = 'ml-auto text-xs text-gray-500';
                meta.textContent = (file.content_type || '') + (file.size ? ` Â· ${file.size}B` : '');
                const dl = document.createElement('a');
                dl.textContent = 'ä¸‹è½½';
                dl.className = 'text-sm underline ml-3';
                dl.href = `/api/files/${encodeURIComponent(file.id)}/download`;
                dl.target = '_blank';
                dl.addEventListener('click', (e) => {
                    e.preventDefault();
                    const token = tokenInput.value.trim();
                    if (!token) { appendMsg('ai', 'è¯·å…ˆå¡«å†™ Canvas Token'); return; }
                    fetch(dl.href, { headers: { 'X-Canvas-Token': token } })
                        .then(async (resp) => {
                            if (!resp.ok) {
                                const msg = await resp.text().catch(() => resp.statusText);
                                throw new Error(msg || 'ä¸‹è½½å¤±è´¥');
                            }
                            const blob = await resp.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = (file.display_name || `file_${file.id}`);
                            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        })
                        .catch(err => appendMsg('ai', 'ä¸‹è½½å¤±è´¥ï¼š' + (err.message || String(err))));
                });
                row.appendChild(icon); row.appendChild(name); row.appendChild(meta); row.appendChild(dl);
                return row;
            }

            const rootTitle = document.createElement('div');
            rootTitle.className = 'text-sm text-gray-600';
            rootTitle.textContent = (node.full_name || node.name || 'è¯¾ç¨‹æ–‡ä»¶');
            container.appendChild(rootTitle);

            if (Array.isArray(node.folders)) {
                node.folders.forEach(sub => container.appendChild(createFolder(sub)));
            }
            if (Array.isArray(node.files) && node.files.length) {
                const filesWrap = document.createElement('div');
                filesWrap.className = 'mt-1';
                node.files.forEach(f => filesWrap.appendChild(createFile(f)));
                container.appendChild(filesWrap);
            }
            return container;
        }

        // è§£æ Agent è¿”å›ä¸­çš„ UI æŒ‡ä»¤å ä½ç¬¦ï¼Œå¹¶æ‰§è¡Œå¯¹åº”åŠ¨ä½œ
        function handleAgentUI(text) {
            let cleaned = String(text || '');
            debugLog('handleAgentUI.input', cleaned);
            const reOpen = /__UI_FILE_BROWSER_OPEN__(\{[\s\S]*?\})__/g; // å…¼å®¹æ—§æŒ‡ä»¤ï¼šä¾§æ æ‰“å¼€
            const reCard = /__UI_FILE_BROWSER_CARD__(\{[\s\S]*?\})__/g; // æ–°æŒ‡ä»¤ï¼šå¯¹è¯å¡ç‰‡
            let match;
            let found = false;
            while ((match = reCard.exec(cleaned)) !== null) {
                found = true;
                const payloadStr = match[1];
                debugLog('UI CARD directive raw', payloadStr);
                let payload = null;
                try {
                    payload = JSON.parse(payloadStr);
                    debugLog('UI CARD directive parsed', payload);
                } catch (e) {
                    debugLog('UI CARD JSON.parse error', e, payloadStr);
                }
                const cid = payload && (payload.courseId ?? payload.course_id);
                try {
                    insertFileBrowserCard(cid);
                } catch (e) {
                    debugLog('insertFileBrowserCard error', e, cid);
                }
            }
            if (found) cleaned = cleaned.replace(reCard, '').trim();

            // å…¼å®¹æ—§æŒ‡ä»¤ï¼šå°†å…¶ä¹Ÿè½¬ä¸ºå¯¹è¯å¡ç‰‡
            while ((match = reOpen.exec(cleaned)) !== null) {
                const payloadStr = match[1];
                debugLog('UI OPEN directive raw', payloadStr);
                let payload = null;
                try {
                    payload = JSON.parse(payloadStr);
                    debugLog('UI OPEN directive parsed', payload);
                } catch (e) {
                    debugLog('UI OPEN JSON.parse error', e, payloadStr);
                }
                const cid = payload && (payload.courseId ?? payload.course_id);
                try {
                    insertFileBrowserCard(cid);
                } catch (e) {
                    debugLog('insertFileBrowserCard error (compat)', e, cid);
                }
                cleaned = cleaned.replace(reOpen, '').trim();
            }
            debugLog('handleAgentUI.cleaned', cleaned);
            return cleaned;
        }

		checkBtn.addEventListener('click', async () => {
			try {
				const resp = await fetch('/api/health');
				const data = await resp.json();
				appendMsg('ai', 'å¥åº·æ£€æŸ¥ï¼š' + JSON.stringify(data));
			} catch (e) {
				appendMsg('ai', 'å¥åº·æ£€æŸ¥å¤±è´¥ï¼š' + (e.message || String(e)));
			}
		});

		runToolBtn.addEventListener('click', async () => {
			try {
				saveSession();
				const token = tokenInput.value.trim();
				if (!token) {
					appendMsg('ai', 'è¯·å…ˆå¡«å†™ Canvas Token');
					return;
				}
				statusEl.textContent = 'è°ƒç”¨å·¥å…·ä¸­â€¦';
				const body = { tool: toolSelect.value, canvas_token: token };
				if (toolSelect.value === 'get_announcements') {
					const name = (toolCourseInput.value || '').trim();
					if (name) body['course_name'] = name;
				}
                const resp = await fetch('/api/tool_test', {
					method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-AGENT-VERBOSE': 'true' },
					body: JSON.stringify(body)
				});
				
				if (!resp.ok) {
					const err = await resp.json().catch(() => ({ detail: resp.statusText }));
					throw new Error(err.detail || 'è¯·æ±‚å¤±è´¥');
				}
                const data = await resp.json();
                debugLog('tool_test.raw', data);
                const handled = handleAgentUI(data.result || 'ï¼ˆæ— å†…å®¹ï¼‰');
                if (handled) appendMsg('ai', handled);
                pushHistory('assistant', handled || '');
			} catch (e) {
				appendMsg('ai', 'å·¥å…·è°ƒç”¨é”™è¯¯ï¼š' + (e.message || String(e)));
			} finally {
				statusEl.textContent = '';
			}
		});

		loadTreeBtn.addEventListener('click', async () => {
			try {
				const token = tokenInput.value.trim();
				const cid = Number(courseIdInput.value || '');
				if (!token) { appendMsg('ai', 'è¯·å…ˆå¡«å†™ Canvas Token'); return; }
				if (!cid) { appendMsg('ai', 'è¯·å¡«å†™æœ‰æ•ˆçš„è¯¾ç¨‹ ID'); return; }
				statusEl.textContent = 'åŠ è½½æ–‡ä»¶æ ‘ä¸­â€¦';
				fileTreeEl.innerHTML = '';
				const resp = await fetch(`/api/courses/${encodeURIComponent(cid)}/file_tree`, {
					headers: { 'X-Canvas-Token': token }
				});
				if (!resp.ok) {
					const errText = await resp.text().catch(() => resp.statusText);
					throw new Error(errText || 'è¯·æ±‚å¤±è´¥');
				}
				const data = await resp.json();
				const root = (data && data.root) ? data.root : null;
				if (!root) { fileTreeEl.textContent = 'æœªè·å–åˆ°æ–‡ä»¶æ ‘'; return; }
				fileTreeEl.appendChild(renderTree(root));
			} catch (e) {
				appendMsg('ai', 'åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥ï¼š' + (e.message || String(e)));
			} finally {
				statusEl.textContent = '';
			}
		});

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
            saveSession();
			const token = tokenInput.value.trim();
			const message = qInput.value.trim();
			if (!message) { return; }
			if (!token) {
				appendMsg('ai', 'è¯·å…ˆè®¾ç½® Canvas API Token å†å‘èµ·è¯·æ±‚ã€‚');
				return;
			}

			appendMsg('user', message);
            pushHistory('user', message);
			qInput.value = '';
			statusEl.textContent = 'æ€è€ƒä¸­â€¦';

			try {
                const headers = { 'Content-Type': 'application/json', 'X-AGENT-VERBOSE': 'true' };
				// å¯é€‰ï¼šå°† LLM é…ç½®é€ä¼ ç»™åç«¯ï¼ˆç¤ºä¾‹æ€§åšæ³•ï¼Œç”¨äºå¿«é€Ÿæ¼”ç¤ºï¼›ç”Ÿäº§åº”é…ç½®åœ¨æœåŠ¡å™¨ï¼‰
				if (baseUrlInput.value) headers['X-LLM-BASE'] = baseUrlInput.value;
				if (llmKeyInput.value) headers['X-LLM-KEY'] = llmKeyInput.value;

                const resp = await fetch('/api/chat', {
					method: 'POST',
					headers,
                    body: JSON.stringify({ message, canvas_token: token, history: chatHistory })
				});
				if (!resp.ok) {
					const err = await resp.json().catch(() => ({ detail: resp.statusText }));
					throw new Error(err.detail || 'è¯·æ±‚å¤±è´¥');
				}
                const data = await resp.json();
                debugLog('chat.raw', data);
                const handled = handleAgentUI(data.answer || 'ï¼ˆæ— å†…å®¹ï¼‰');
                if (handled) appendMsg('ai', handled);
                pushHistory('assistant', handled || '');
			} catch (err) {
				appendMsg('ai', 'é”™è¯¯ï¼š' + (err.message || String(err)));
			} finally {
				statusEl.textContent = '';
			}
		});

		// å›¾æ ‡æ¸²æŸ“
		if (window.lucide) { window.lucide.createIcons(); }
	</script>
	<script src="https://cdn.jsdelivr.net/npm/flowbite@2.0.0/dist/flowbite.min.js"></script>
</body>
</html>
